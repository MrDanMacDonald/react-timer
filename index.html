<html>
  <head>
    <title>Images</title>
    <link type='text/css' rel='stylesheet' href='styles.css'/>
    <script src='http://fb.me/react-0.12.2.js'></script>
    <script src='http://fb.me/JSXTransformer-0.12.2.js'></script>
    <script type='text/javascript' src='https://code.jquery.com/jquery-2.1.1.min.js'></script>
  </head>
  <body>
    <div id='content'></div>
    <script type='text/jsx'>

      var PopularList = React.createClass({
        propTypes: {
          apiKey: React.PropTypes.string.isRequired
        },
        getInitialState: function() {
          return {
            data: {},
            favorites: []
          };
        },
        loadImagesFromInstagram: function() {
          var url = 'https://api.instagram.com/v1/media/popular?client_id=' + this.props.apiKey + '&callback=?';
          $.ajax({
            url: url,
            dataType: 'json',
            success: function(data) {
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        componentDidMount: function() {
          this.loadImagesFromInstagram();
        },
        handleClicked: function(photoObj) {
          if (photoObj.state.selected == true) {
            this.setState({
              favorites: this.state.favorites.push(photoObj)
            });
          };
        },
        render: function() {
          var popularPhotos = []
          var popularListObj = this
          if ('data' in this.state.data) {
            popularPhotos = this.state.data.data.map(function(photo, i) {
              return (
                <Photo 
                  photo={photo}
                  onClick={popularListObj.handleClicked} />
              );
            });
          };

          // Set key equal to a function that checks for favorites, so that it's forced to calculate
          // and 'break the cache' if favorites change

          var favoritePhotos = []
          if (this.state.favorites.length > 0) {
            this.state.favorites.map(function(photo, i) {
              return (
                photo
              );
            });
          };

          return (
            <div>
              <h2>Popular Photos</h2>
              <div className='pictures'>
                {popularPhotos}
              </div>
              <h2>Favorite Photos</h2>
              <div className='pictures'>
                {favoritePhotos}
              </div>
            </div>
          );
        }
      });

      var Photo = React.createClass({
        propTypes: {
          photo: React.PropTypes.object.isRequired,
          onClick: React.PropTypes.func.isRequired
        },
        getInitialState: function() {
          return {
            selected: false
          };
        },
        handleClicked: function() {
          this.setState({
            selected: true
          }, function () {
            this.props.onClick(this);
          }.bind(this));
        },
        render: function() {
          return (
            <div className='picture' onClick={this.handleClicked}>
              <img src={this.props.photo.images.low_resolution.url} width='200' />
            </div>
          );
        }
      });

      React.render(
        <PopularList apiKey='642176ece1e7445e99244cec26f4de1f' />,
          document.getElementById('content')
      );
    </script>
  </body>
</html>
